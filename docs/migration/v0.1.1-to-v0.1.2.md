# 迁移指南：v0.1.1 → v0.1.2

## 高音符号语法变更

### 变更内容

**旧语法**（v0.1.1 及之前）：高音符号 `'` 写在音符**后面**
```
1 2 3' 4' 5' 6' 7' 1''
```

**新语法**（v0.1.2 起）：高音符号 `'` 写在音符**前面**
```
1 2 '3 '4 '5 '6 '7 ''1
```

### 变更原因

为保持语法一致性：
- **低音符号** `.` 一直是前缀：`.7` `.6` `.5`
- **高音符号** `'` 现在也是前缀：`'1` `'2` `'3`

统一使用前缀模式，降低学习成本，符合直觉。

---

## 如何迁移

### 自动替换（推荐）

使用正则表达式批量替换：

**查找**: `([1-7])('+)`  
**替换**: `$2$1`

**VS Code 操作步骤**:
1. 按 `Cmd+H` (macOS) 或 `Ctrl+H` (Windows/Linux) 打开替换面板
2. 点击 `.*` 按钮启用正则表达式模式
3. 在"查找"框输入：`([1-7])('+)`
4. 在"替换"框输入：`$2$1`
5. 点击"全部替换"

### 手动替换对照表

| 旧语法 | 新语法 | 音高 |
|--------|--------|------|
| `1'` | `'1` | 高音 do |
| `2'` | `'2` | 高音 re |
| `3'` | `'3` | 高音 mi |
| `4'` | `'4` | 高音 fa |
| `5'` | `'5` | 高音 sol |
| `6'` | `'6` | 高音 la |
| `7'` | `'7` | 高音 si |
| `1''` | `''1` | 超高音 do |

---

## 示例对比

### 示例 1：小星星（片段）

**旧版本**:
```
1 1 5 5 | 6 6 5 - | 4 4 3 3 | 2 2 1 - |
```
✅ 无变化（没有高音符号）

### 示例 2：生日快乐

**旧版本**:
```
5_ 5_ 6 5 | 1' 7 - | 5_ 5_ 6 5 | 2' 1' - |
5_ 5_ 5' 3' | 1' 7 6 | 4'_ 4'_ 3' 1' | 2' 1' - |
```

**新版本**:
```
5_ 5_ 6 5 | '1 7 - | 5_ 5_ 6 5 | '2 '1 - |
5_ 5_ '5 '3 | '1 7 6 | '4_ '4_ '3 '1 | '2 '1 - |
```

### 示例 3：圆滑线示例

**旧版本**:
```
(1 2 3) 4 | (5 6 | 7 1') 2' | (3'_ 3'_ 2' 1') 7 | 1' - - - |
```

**新版本**:
```
(1 2 3) 4 | (5 6 | 7 '1) '2 | ('3_ '3_ '2 '1) 7 | '1 - - - |
```

---

## 兼容性说明

### 不兼容变更

⚠️ **旧语法将无法识别**：使用 `1'` 格式的曲谱在 v0.1.2 中会被解析为两个独立元素（`1` 和未知符号 `'`），导致错误。

### 升级建议

1. **立即升级**: 如果你的曲谱库较小（<10 首）
2. **批量处理**: 如果有大量曲谱，使用正则替换工具
3. **逐步迁移**: 保留旧版本备份，新曲谱使用新语法

### 测试验证

升级后请验证：
1. 所有高音符号位置正确
2. 曲谱渲染无错误
3. 播放音高准确

---

## 技术细节（开发者）

### Tokenizer 变更

**旧逻辑** (v0.1.1):
```typescript
// 高八度（'）在数字后
else if (ch === "'") {
  tokens.push({ type: 'OCTAVE_UP', ... });
}
```

**新逻辑** (v0.1.2):
```typescript
// 高八度（'）在数字前（前缀）
else if (ch === "'") {
  const nextCh = i + 1 < bodyLine.length ? bodyLine[i + 1] : '';
  if (nextCh >= '1' && nextCh <= '7') {
    tokens.push({ type: 'OCTAVE_UP', ... });
  }
}
```

### Parser 变更

**旧逻辑** (v0.1.1): 高八度在**后置修饰符**处理  
**新逻辑** (v0.1.2): 高八度在**前置修饰符**处理（与低八度一致）

---

## 常见问题

### Q1: 为什么不同时支持两种语法？

**A**: 为避免语法歧义和维护复杂度。单一语法更清晰、更易学习。

### Q2: 如何快速检查我的曲谱是否需要迁移？

**A**: 在编辑器中搜索正则 `[1-7]'`，如果有匹配项，说明需要迁移。

### Q3: 迁移后播放音高会改变吗？

**A**: 不会。`1'` → `'1` 只是写法变化，音高保持不变。

### Q4: 有自动化迁移工具吗？

**A**: 暂无独立工具，推荐使用文本编辑器的正则替换功能（见上文）。

---

## 帮助与反馈

如有问题，请：
- 查看 [简谱源码编写说明](../user-guide/notation-syntax.md)
- 提交 Issue: [GitHub Issues](https://github.com/your-repo/issues)
- 参考示例曲谱了解新语法

---

**版本**: v0.1.2  
**日期**: 2026年2月8日
